<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="UTF-8" />
		<meta name="renderer" content="webkit" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=0,uc-fitscreen=yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no" />
		<title>miniMobile</title>
		<meta name="keywords" content="miniMobile的demo" />
		<meta name="description" content="miniMobile是一个简单易用的移动框架！" />
		<!-- miniMObile.css、js -->
		<link rel="stylesheet" type="text/css" href="css/miniMobile.css" />
		<script type="text/javascript" src="js/zepto.min.js"></script>
		<script type="text/javascript" src="js/miniMobile.js"></script>
		<!-- fonticon -->
		<link rel="stylesheet" type="text/css" href="plugins/fonticon/iconfont.css" />
		<!-- animate.css -->
		<link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/animate.css/3.5.2/animate.min.css" />
		<!-- layer -->
		<script type="text/javascript" src="plugins/layer_mobile/layer.js"></script>
		<!--软键盘-->
		<script type="text/javascript" src="plugins/webKeyBoard.js"></script>
	</head>

	<body class="pb12 fadeIn animated" style="padding-bottom: 65px;">
		<header class="ui-header clearfix w75 pl3 pr3 h8 f46  color8 bg-color-primary t-c header">
			<div class="ui-header-l fl w5 mirrorRotateLevel">
				<a href="my.html" class="icon color8 iconfont icon-arrow-right"></a>
			</div>
			<div class="ui-header-c fl f30 w59">
				修改密码
			</div>
			<!--<div class="ui-header-r fr w5">
				<i class="icon iconfont icon-phone"></i>
			</div>-->
		</header>
		<style>
			.formheader {
				line-height: 0.7rem;
			}
			
			.formheader span {
				display: inline-block;
			}
			
			.formheader input {
				border: none;
			}
			
			.mirrorRotateLevel {
				/* 水平镜像翻转 */
				-moz-transform: scaleX(-1);
				-webkit-transform: scaleX(-1);
				-o-transform: scaleX(-1);
				transform: scaleX(-1);
				/*兼容IE*/
				filter: FlipH;
			}
		</style>
		<div class="p3 f30 f30 w75 main">
			<form>
				<div class="m3 color4 f32 progresslist" id="progress_div25">
					<progress class="ui-progress" max="100" value="25" id="progress25"></progress>
				</div>
				<div class="m3 color4 f32 progresslist" id="progress_div50">
					<progress class="ui-progress" max="100" value="50" id="progress50"></progress>
				</div>
				<div class="m3 color4 f32 progresslist" id="progress_div75">
					<progress class="ui-progress" max="100" value="75" id="progress75"></progress>
				</div>
				<div class="m3 color4 f32 progresslist" id="progress_div100">
					<progress class="ui-progress" max="100" value="100" id="progress100"></progress>
				</div>
				<div class="f30 m2 color3">
					<dl class="o-h" id="step1_1">
						<dt class="pl3 pr3 f34">第一步：校验邮箱</dt></br>
						<dd class="p2 pl3 pr3 bg-color7">
							<h2 class="t-c f34 color-warning"><i class="icon iconfont icon-info"></i>为了您的帐号安全<br/>
							请输入您绑定的完整邮箱</h2>
							<center>
								<font class="t-c f32 color4">提示：<span id="tips_email_label">****@hualuoo.com</span></font>
							</center>
							</br>
							<div class="pt1 pb1">
								旧邮箱：
								<input type="text" class="w59  form-control" id="old_email_input" placeholder="请输入完整的邮箱地址" style="width: 240px;" />
							</div>
							<font class="t-c f30 color1" id="step1_1_error_label"></font>
						</dd>
					</dl>
					<dl class="o-h" id="step1_2">
						<dt class="pl3 pr3 f34">第二步：验证身份</dt></br>
						<dd class="p2 pl3 pr3 bg-color7">
							<h2 class="t-c f34 color-warning">
								<i class="icon iconfont icon-info"></i>为了您的帐号安全<br/>
								需要发送验证码到您绑定的邮箱</h2>
							</br>
							<div class="pt1 pb1">
								验证方式：邮箱验证<span class="f26 color4" id="old_email_lable"></span>
							</div>
							<div class="pt1 pb1">
								&emsp;验证码：
								<input type="text" class="w59  form-control" id="old_email_captcha" placeholder="输入验证码" style="width: 110px;" />
								<input type="button" class="btn f28 btn-success radius10 h6 w20" value="邮箱验证" id="send_old_captcha_button" onclick="send_old_email_captcha()" />
							</div>
							<font class="t-c f30 color1" id="step1_2_error_label"></font>
						</dd>
					</dl>
					<dl class="o-h" id="step1_3">
						<dt class="pl3 pr3 f34">第三步：输入新密码</dt></br>
						<dd class="p2 pl3 pr3 bg-color7">
							<div class="pt1 pb1">
								新密码：
								<input type="password" class="w59  form-control" id="new_password_input" placeholder="请输入新的账户密码" style="width: 240px;" />
							</div>
							<font class="t-c f30 color1" id="step1_3_error_label"></font>
						</dd>
					</dl>
					<dl class="o-h" id="step1_4">
						<dt class="pl3 pr3 f34">第四步：完成</dt></br>
						<dd class="p2 pl3 pr3 bg-color7">
							<h2 class="t-c f34 color-primary"><i class="icon iconfont icon-check"></i>您的账户密码已修改成功<br/>
							<br/>
							请牢记您的密码以防遗失</h2>
						</dd>
					</dl>
					<dl class="o-h" id="step2_1">
						<dt class="pl3 pr3 f34">第一步：操作中止</dt></br>
						<dd class="p2 pl3 pr3 bg-color7">
							<h2 class="t-c f34 color1"><i class="icon iconfont icon-info"></i>该账户未绑定邮箱<br/>
							请先绑定邮箱再进行下一步操作！</h2>
							</br>
						</dd>
					</dl>
				</div>
				<div class="t-c mt5" id="next_step_button">

				</div>
			</form>
		</div>
		<!-- 底部导航 -->
		<nav class="demo-bottomNav mt6 w75 h12 pt1 t-c f28 bg-color8 o-h clearfix" style="position: fixed; left: 0px; bottom: 0px; width: 100%; height: 65px; background-color: #eee; z-index: 9999;">
			<div class="footer"></div>
		</nav>

		<!-- check-token -->
		<script src="js/check-token.js"></script>
		<script>
			// 获取公共底部
			$(document).ready(function() {
				$(".footer").load("footer.html");
			});
			
			// 进度条
			$("#progress25").progressUi({
				skin: "primary"
			});
			$("#progress50").progressUi({
				skin: "primary"
			});
			$("#progress75").progressUi({
				skin: "primary"
			});
			$("#progress100").progressUi({
				skin: "primary"
			});

			// 初始化
			$('#step1_1').hide();
			$('#step1_2').hide();
			$('#step1_3').hide();
			$('#step1_4').hide();
			$('#step2_1').hide();
			$("#progress_div25").hide();
			$("#progress_div50").hide();
			$("#progress_div75").hide();
			$("#progress_div100").hide();
			
			// 软键盘初始化
			$(function() {
				var mykeyboard = $.keyboard({
					num: 6,
					title: "验证码",
					msg: "正在校验验证码",
					skin: "jianpan",
					callback: function(data) {
						$('#old_email_captcha').val(data.toString().replace(/,/g, ""));
						confirm_old_email_captcha();
						mykeyboard.hideKeyBoard();
					}
				});
				$('#old_email_captcha').focus(function() {
					mykeyboard.showKeyBoard();
					document.activeElement.blur();
				});
			})
			
			// 数据加载
			$.ajax({
				url: "http://s1.mc.fyi:11453/users/get_info_self/",
				type: "get",
				headers: {
					"Authorization": "JWT " + localStorage.getItem("cache_token")
				},
				dataType: "json",
				success: function(data) {
					if(data.email) {
						$('#step1_1').show();
						$("#progress_div25").show();
						$('#tips_email_label').html(data.email);
						$('#next_step_button').html('<input type="button" class="btn f30 btn-primary radius10 p2 w30" value="下一步" onclick="check_old_email()"/>');
					} else {
						$('#step2_1').show();
						$("#progress_div100").show();
						$('#next_step_button').html('<input type="button" class="btn f30 btn-primary radius10 p2 w30" value="前往邮箱绑定" onclick="go_change_email()"/>')
					}
				},
				error: function(jqXHR) {
					layer.open({
						content: '数据加载错误，请尝试重新登录',
						skin: 'msg',
						time: 2
					});
					setTimeout('location.href = "login.html"', 2000);
				}
			});

			// step1_1 旧邮箱输入框监听
			$('#old_email_input').on('input', function() {
				var inputContent = $('#old_email_input').val();
				if($.trim(inputContent) == '') {
					$('#step1_1_error_label').html('<i class="icon iconfont icon-close"></i>请输入邮箱地址');
				} else {
					$('#step1_1_error_label').html('');
				};
			});

			// step1_1 校验旧邮箱
			function check_old_email() {
				if($.trim($('#old_email_input').val()) == '') {
					$('#step1_1_error_label').html('<i class="icon iconfont icon-close"></i>请输入邮箱地址');
					return false;
				}
				$.ajax({
					url: "http://s1.mc.fyi:11453/member/security/check_old_email/",
					type: "post",
					headers: {
						"Authorization": "JWT " + localStorage.getItem("cache_token")
					},
					dataType: "json",
					data: {
						"old_email": $('#old_email_input').val()
					},
					success: function(data) {
						$('#step1_1').hide();
						$("#progress_div25").hide();
						$('#step1_2').show();
						$("#progress_div50").show();
						$('#next_step_button').html('<input type="button" class="btn f30 btn-primary radius10 p2 w30" value="下一步" onclick="confirm_old_email_captcha()"/>');
						$('#old_email_lable').html('(' + $('#tips_email_label').html() + ')');
						layer.open({
							content: data.detail,
							skin: 'msg',
							time: 2
						});
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						if(json_responseText.old_email != null) {
							$('#step1_1_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.old_email[0]);
							return false;
						}
						if(json_responseText.detail != null) {
							$('#step1_1_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.detail);
							return false;
						}
						$('#step1_1_error_label').html('<i class="icon iconfont icon-close"></i>发生未知错误，请联系管理员');
					}
				});
			}

			// step1_2 向旧邮箱发送验证码
			function send_old_email_captcha() {
				$.ajax({
					url: "http://s1.mc.fyi:11453/member/security/send_old_email_captcha/",
					type: "post",
					headers: {
						"Authorization": "JWT " + localStorage.getItem("cache_token")
					},
					dataType: "json",
					data: {
						"old_email": $('#old_email_input').val()
					},
					success: function(data) {
						document.getElementById("send_old_captcha_button").disabled = true;
						var num = 60;
						var timer = setInterval(function() {
							num--;
							document.getElementById("send_old_captcha_button").value = "发送成功(" + num + "s)"
							if(num == 0) {
								clearInterval(timer); //到时间取消执行
								document.getElementById("send_old_captcha_button").disabled = false;
								document.getElementById("send_old_captcha_button").value = "重新发送";
							}
						}, 1000); //每1000毫秒执行一次
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						if(json_responseText.old_email != null) {
							layer.open({
								content: json_responseText.old_email[0] + '，即将返回第一步！',
								skin: 'msg',
								time: 2
							});
							setTimeout('window.location.reload()', 2000);
							return false;
						}
						if(json_responseText.detail != null) {
							$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.detail);
							return false;
						}
						$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>发生未知错误，请联系管理员');
					}
				});
			}

			// step1_2 旧邮箱验证码输入框监听
			$('#old_email_captcha').on('input', function() {
				var inputContent = $('#old_email_captcha').val();
				if($.trim(inputContent) == '') {
					$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>请输入验证码');
				} else {
					$('#step1_2_error_label').html('');
				};
			});

			// step1_2 校验旧邮箱 验证码
			function confirm_old_email_captcha() {
				if($.trim($('#old_email_captcha').val()) == '') {
					$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>请输入验证码');
					return false;
				}
				$.ajax({
					url: "http://s1.mc.fyi:11453/member/security/confirm_old_email_captcha/",
					type: "post",
					headers: {
						"Authorization": "JWT " + localStorage.getItem("cache_token")
					},
					dataType: "json",
					data: {
						"old_captcha": $('#old_email_captcha').val()
					},
					success: function(data) {
						$('#step1_2').hide();
						$("#progress_div50").hide();
						$('#step1_3').show();
						$("#progress_div75").show();
						$('#next_step_button').html('<input type="button" class="btn f30 btn-primary radius10 p2 w30" value="下一步" onclick="change_password()"/>');
						layer.open({
							content: data.detail,
							skin: 'msg',
							time: 2
						});
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						if(json_responseText.old_captcha != null) {
							$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.old_captcha[0]);
							return false;
						}
						if(json_responseText.detail != null) {
							$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.detail);
							return false;
						}
						$('#step1_2_error_label').html('<i class="icon iconfont icon-close"></i>发生未知错误，请联系管理员');
					}
				});
			}
			
			// step1_3 密码输入框监听
			$('#new_password_input').on('input', function() {
				var inputContent = $('#new_password_input').val();
				if($.trim(inputContent) == '') {
					$('#step1_3_error_label').html('<i class="icon iconfont icon-close"></i>请输入密码');
				} else {
					$('#step1_3_error_label').html('');
				};
			});
			
			// step1_3 修改密码
			function change_password(){
				$.ajax({
					url: "http://s1.mc.fyi:11453/member/security/change_password/",
					type: "post",
					headers: {
						"Authorization": "JWT " + localStorage.getItem("cache_token")
					},
					dataType: "json",
					data: {
						"old_captcha": $('#old_email_captcha').val(),
						"new_password": $('#new_password_input').val()
					},
					success: function(data) {
						$('#step1_3').hide();
						$("#progress_div75").hide();
						$('#step1_4').show();
						$("#progress_div100").show();
						$('#next_step_button').html('<input type="button" class="btn f30 btn-warning radius10 p2 w30" value="返回" onclick="back()"/>');
						layer.open({
							content: data.detail,
							skin: 'msg',
							time: 2
						});
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						if(json_responseText.old_captcha != null) {
							layer.open({
								content: json_responseText.old_captcha[0] + '，即将返回第一步！',
								skin: 'msg',
								time: 2
							});
							setTimeout('window.location.reload()', 2000);
							return false;
						}
						if(json_responseText.new_password != null) {
							$('#step1_3_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.new_password[0]);
							return false;
						}
						if(json_responseText.detail != null) {
							$('#step1_3_error_label').html('<i class="icon iconfont icon-close"></i>' + json_responseText.detail);
							return false;
						}
						$('#step1_3_error_label').html('<i class="icon iconfont icon-close"></i>发生未知错误，请联系管理员');
					}
				});
			}
			
			// 返回 "我的"
			function back(){
				location.href = "my.html";
			}
			
			// 前往绑定邮箱
			function go_change_email(){
				location.href = "change_email.html";
			}
						
		</script>

		<style type="text/css">
			.userbox {
				line-height: 2em;
				background: url(img/s5.jpg) center 40% no-repeat;
				background-size: cover
			}
			
			.userbox-l img {
				border: 2px solid #fff;
			}
			
			li {
				line-height: 2.5em;
				border-top: 1px solid #F1F1F1;
				border-bottom: 1px solid #F1F1F1;
				margin-top: -1px;
			}
			
			li a {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			.demo-bottomNav {
				line-height: 1.8em;
				border-top: 1px solid #F1F1F1;
			}
			
			.demo-bottomNav a {
				display: block;
				width: 100%;
				height: 100%;
			}
			
			.header {
				padding-bottom: 10%;
				width: 100%;
				position: fixed;
				top: 0px;
				left: 0px;
				z-index: 9998;
			}
			
			.main {
				position: absolute;
				width: 100%;
				height: auto;
				top: 40px;
				padding-bottom: 60px;
			}
		</style>

	</body>

</html>